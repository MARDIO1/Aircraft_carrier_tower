# 航模地面站控制软件 - 详细操作流程

## 系统概述

本软件是一个用于控制航模设备的Python地面站软件，采用状态机架构和二维数组导航系统。软件通过UART串口与航模进行双向通讯，支持实时键盘控制、数据发送与接收、以及动态控制台显示。

## 核心架构

### 状态机系统

软件采用两级状态机架构：

#### 主状态 (MainState)
- **STOP (0x00)**: 停止状态，发送3字节数据包：0xAA + 0x00 + 0xBB
- **AUTO (0x01)**: 自动控制模式，发送21字节数据包：0xAA + 开关 + 风扇 + 4个舵机角度 + 0xBB
- **TOWER (0x02)**: 塔台控制模式，发送21字节数据包：0xAA + 开关 + 风扇 + 4个舵机角度 + 0xBB
- **TUNING (0x03)**: 调参模式，不发送控制数据，用于参数调整

#### 子状态 (SubState) - 仅用于TUNING模式
- **SERVO (0xA1)**: 舵机调参，发送19字节数据包：0xAA + 0xA1 + 4个舵机角度 + 0xBB
- **PID (0xA2)**: PID调参，发送变长数据包：0xAA + 0xA2 + PID索引 + 6个参数 + 0xBB
- **JACOBIAN (0xA3)**: 雅可比矩阵调参，发送变长数据包：0xAA + 0xA3 + 12个矩阵元素 + 0xBB

### 状态转换规则
1. 所有状态都可以切换到STOP
2. 只能从STOP切换到TUNING
3. TUNING可以切换到所有状态
4. AUTO和TOWER之间可以互相切换

## 操作界面说明

控制台采用5行显示：

### 第1行：状态显示
显示当前主状态、子状态、开关状态、风扇转速、舵机角度和导航位置
示例：`模式:TUNING(PID) 开关:ON 风扇:1000 舵机:[0.0,0.0,0.0,0.0] 导航:[0,0]`

### 第2行：发送数据
显示上一次发送的十六进制数据

### 第3行：接收数据
显示从航模接收到的传感器数据（开关状态和角度数据）

### 第4行：导航/调参显示
- 非TUNING模式：显示导航提示和当前位置
- TUNING模式：显示当前调参的具体参数和输入缓冲区

### 第5行：消息队列
显示最近两条系统消息

## 详细操作流程

### 1. 启动程序
```bash
# 使用uv运行
uv run python src/main.py

# 或直接运行
python src/main.py
```

### 2. 初始状态 (STOP模式)
程序启动后默认处于STOP模式，显示如下：
```
模式:STOP 开关:OFF 风扇:0 舵机:[0.0,0.0,0.0,0.0] 导航:[0,0]
发送:AA00BB
接收:无数据
导航:行=0,列=0 (上下左右导航,Enter确认)
```

### 3. 状态切换导航

#### 从STOP切换到其他模式
在STOP模式下，使用上下键在三个选项间导航：
- 行0: 切换到AUTO模式
- 行1: 切换到TOWER模式
- 行2: 切换到TUNING模式

操作步骤：
1. 使用上下键选择目标模式
2. 按Enter键确认切换
3. 系统将切换到选中的模式

### 4. AUTO/TOWER模式操作

#### 导航系统
在AUTO或TOWER模式下，使用二维数组导航：
- 行：固定为0（只有一行参数）
- 列：0-5（开关、风扇、舵机1-4）

操作步骤：
1. 使用左右键在6个参数间导航
2. 按Enter键进入参数编辑模式
3. 输入数字（0-9）设置参数值
4. 按Enter键确认输入
5. 按Esc键取消编辑

#### 参数说明
- 列0（开关）：输入0或1（0=OFF, 1=ON）
- 列1（风扇）：输入0-2000之间的整数
- 列2-5（舵机1-4）：输入浮点数角度值

#### 快速操作
- 空格键：在AUTO/TOWER和STOP之间切换开关状态
- F1-F9键：快速切换到预设状态

### 5. TUNING模式操作

#### 进入TUNING模式
1. 在STOP模式下，导航到"切换到TUNING模式"（行2）
2. 按Enter键进入TUNING模式

#### 选择子模式
进入TUNING模式后，显示三个子模式选项：
- 行0: 舵机调参 (SERVO)
- 行1: PID调参 (PID)
- 行2: Jacobian调参 (JACOBIAN)

操作步骤：
1. 使用上下键选择子模式
2. 按Enter键进入选中的子模式

### 6. SERVO调参模式

#### 导航系统
- 行：固定为0（只有一行）
- 列：0-3（舵机1-4）

操作步骤：
1. 使用左右键在4个舵机间导航
2. 输入数字和小数点设置角度值
3. 按Enter键确认输入
4. 按Esc键退出调参模式

### 7. PID调参模式

#### 导航系统（二维数组）
- 行：0-7（0=选择PID组，1-7=具体PID参数）
- 列：0-5（kp, ki, kd, 积分限幅, 正输出限幅, 负输出限幅）

#### 操作流程
**步骤1：选择PID组**
1. 导航到行0（PID组选择）
2. 使用左右键在7个PID组间导航：
   - 列0: 内环主翼
   - 列1: 内环尾翼
   - 列2: 姿态环-roll
   - 列3: 姿态环-pitch
   - 列4: 姿态环-yaw
   - 列5: 外环-yaw
   - 列6: 外环-高度
3. 按Enter键选中PID组

**步骤2：调整参数**
1. 自动进入参数编辑模式（行1-7对应选中的PID组）
2. 使用上下键在6个参数间导航：
   - 行1: kp
   - 行2: ki
   - 行3: kd
   - 行4: 积分限幅
   - 行5: 正输出限幅
   - 行6: 负输出限幅
3. 输入数字和小数点设置参数值
4. 按Enter键确认当前参数并自动移动到下一个参数
5. 重复步骤3-4直到所有参数设置完成
6. 按Esc键退出调参模式

#### 显示格式
在PID调参模式下，第4行显示当前编辑的参数：
```
内环主翼.kp=9.000 [输入:2.3]
```
- 左侧：参数名称和当前值
- 右侧：输入缓冲区内容

### 8. Jacobian调参模式

#### 导航系统（二维数组）
- 行：0-2（矩阵的3行）
- 列：0-3（矩阵的4列）

#### 操作流程
1. 使用上下左右键在3x4矩阵的12个元素间导航
2. 输入数字和小数点设置矩阵元素值
3. 按Enter键确认当前元素并自动移动到下一个元素
   - 同一行内：向右移动
   - 行末：移动到下一行开头
   - 矩阵末尾：退出调参模式
4. 按Esc键退出调参模式

### 9. 通用操作

#### 输入缓冲区操作
- 数字键0-9：添加数字到缓冲区
- 小数点键：添加小数点（只能添加一次）
- 退格键：删除最后一个字符
- Enter键：确认输入并更新参数值

#### 导航操作
- 上箭头：向上移动（减少行索引）
- 下箭头：向下移动（增加行索引）
- 左箭头：向左移动（减少列索引）
- 右箭头：向右移动（增加列索引）
- Enter键：确认选择/进入编辑模式
- Esc键：取消/返回上一级

#### 快速操作
- 空格键：切换总开关（在AUTO/TOWER模式下）
- F1-F9：切换到预设状态1-9
- Ctrl+C：安全退出程序

### 10. 预设状态说明

| 按键 | 开关 | 风扇转速 | 舵机角度 |
|------|------|----------|----------|
| F1   | 1    | 1000     | [0,0,0,0] |
| F2   | 1    | 1500     | [0,0,0,0] |
| F3   | 1    | 1300     | [0,0,0,0] |
| F4   | 1    | 1400     | [0,0,0,0] |
| F5   | 1    | 1600     | [0,0,0,0] |
| F6   | 1    | 1700     | [0,0,0,0] |
| F7   | 1    | 1800     | [0,0,0,0] |
| F8   | 1    | 1900     | [0,0,0,0] |
| F9   | 1    | 1990     | [0,0,0,0] |

### 11. 故障排除

#### 常见问题
1. **中文字符显示不完整**
   - 问题：如"环主翼"显示不完整（应该是"内环主翼"）
   - 原因：中文字符在终端显示时占用2个字符宽度
   - 解决方案：已实现智能截断功能，确保中文字符不被错误截断

2. **导航无响应**
   - 检查程序窗口是否处于活动状态
   - 确认键盘方向键功能正常
   - 验证当前状态是否支持导航操作

3. **参数无法修改**
   - 确认已按Enter键进入编辑模式
   - 检查输入缓冲区是否正确
   - 验证参数值是否在有效范围内

4. **串口连接失败**
   - 检查USB转TTL模块连接
   - 确认COM口未被其他程序占用
   - 验证波特率设置（115200）

#### 调试信息
- 程序启动时显示可用COM口列表
- 运行过程中实时显示发送和接收状态
- 消息队列显示系统操作记录

### 12. 状态转换流程图

```
      [STOP]
        │
        ├── Enter(行0) ──→ [AUTO]
        │
        ├── Enter(行1) ──→ [TOWER]
        │
        └── Enter(行2) ──→ [TUNING]
                              │
                              ├── Enter(行0) ──→ [SERVO调参]
                              │
                              ├── Enter(行1) ──→ [PID调参]
                              │
                              └── Enter(行2) ──→ [Jacobian调参]
```

### 13. 重要注意事项

1. **状态保护**：只能在STOP状态下切换到TUNING模式
2. **输入确认**：所有参数修改都需要按Enter键确认
3. **缓冲区清空**：切换状态时会自动清空输入缓冲区
4. **实时发送**：在AUTO/TOWER模式下，参数修改会实时发送到航模
5. **调参安全**：在TUNING模式下，参数修改不会立即发送，需要手动确认

### 14. 扩展性说明

本系统的状态机架构和二维数组导航设计具有良好的扩展性：

1. **添加新状态**：在MainState枚举中添加新状态，并实现对应的编码器
2. **添加新参数**：在ProtocolData类中添加新参数，并更新导航配置
3. **修改导航结构**：在StateMachineManager中更新nav_config字典
4. **添加新显示**：在Consle类中添加新的显示方法

通过这种模块化设计，系统可以轻松适应不同的控制需求和硬件配置。

---

*最后更新：2025年12月21日*
*版本：v2.0（状态机+二维数组导航版本）*
