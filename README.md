# 航空母舰塔楼 - 航模地面站控制软件

## 项目概述
这是一个用于控制航模设备的Python地面站软件，通过UART串口与航模进行双向通讯。软件采用多线程架构，支持实时键盘控制、数据发送与接收、以及动态控制台显示。

## 功能特性
- **双向UART通讯**：波特率115200，8N1配置，支持发送控制和接收传感器数据
- **实时键盘控制**：空格键切换总开关，数字1-9选择预设状态
- **动态控制台GUI**：使用ANSI转义码实现实时刷新显示
- **多线程架构**：输入捕获、数据发送、数据接收、界面显示分离处理
- **自动COM口检测**：自动列出可用串口，支持手动配置
- **预设状态管理**：9个可配置的预设状态，快速切换控制参数

## 硬件要求
- USB转TTL串口模块（如CH340、CP2102等）
- 航模设备支持UART通讯协议
- 支持发送控制指令和接收传感器数据

## 软件要求
- Python 3.13+
- uv包管理器（推荐）或pip
- Windows/Linux/macOS系统

## 安装依赖
```bash
# 使用uv包管理器（推荐）
uv sync

# 或使用pip
pip install keyboard pyserial
```

## 运行程序
```bash
# 使用uv运行
uv run python src/main.py

# 或直接运行
python src/main.py
```

## 操作说明
- **空格键**: 切换总开关状态 (0/1)
- **数字1**: 预设状态1 - 开关=1, 风扇=1000, 舵机=[45,45,45,45]
- **数字2**: 预设状态2 - 开关=1, 风扇=1500, 舵机=[0,0,0,0]
- **数字3**: 预设状态3 - 开关=1, 风扇=1300, 舵机=[45,45,45,45]
- **数字4**: 预设状态4 - 开关=1, 风扇=1400, 舵机=[45,45,45,45]
- **数字5**: 预设状态5 - 开关=1, 风扇=1600, 舵机=[45,45,45,45]
- **数字6**: 预设状态6 - 开关=1, 风扇=1700, 舵机=[45,45,45,45]
- **数字7**: 预设状态7 - 开关=1, 风扇=1800, 舵机=[45,45,45,45]
- **数字8**: 预设状态8 - 开关=1, 风扇=1900, 舵机=[45,45,45,45]
- **数字9**: 预设状态9 - 开关=1, 风扇=1990, 舵机=[45,45,45,45]
- **Ctrl+C**: 安全退出程序

## 通讯协议

### 地面站发送协议（地面站→航模）
```
数据格式：0xAA + uint8[1]总开关 + int16[1]风扇转速 + int16[4]四个舵机目标角度 + 0xBB
总长度：13字节
字节说明：
  0: 起始字节 0xAA
  1: 总开关 (0或1)
  2-3: 风扇转速 (int16, 小端序)
  4-5: 舵机1角度 (int16, 小端序)
  6-7: 舵机2角度 (int16, 小端序)
  8-9: 舵机3角度 (int16, 小端序)
  10-11: 舵机4角度 (int16, 小端序)
  12: 结束字节 0xBB
发送频率：50Hz (每20ms发送一次)
```

### 航模接收协议（航模→地面站）
```
数据格式：0xCC + uint8开关 + float[3]加速度 + float[3]陀螺仪 + float[3]角度 + 0xDD
总长度：39字节
字节说明：
  0: 起始字节 0xCC
  1: 开关状态
  2-13: 加速度数据 (3个float, 每个4字节，小端序)
  14-25: 陀螺仪数据 (3个float, 每个4字节，小端序)
  26-37: 角度数据 (3个float, 每个4字节，小端序)
  38: 结束字节 0xDD
```

## 项目结构
```
src/
├── main.py          # 主程序入口，负责线程管理和系统协调
├── initial.py       # 初始化模块，负责串口检测和配置
├── protocol.py      # 通讯协议配置，数据编码解码
├── playerInput.py   # 键盘输入捕获，处理按键事件
├── UART_send.py     # 串口数据发送，50Hz恒定频率
├── UART_receive.py  # 串口数据接收，实时解码传感器数据
└── terminal_GUI.py  # 控制台界面，四行动态显示
```

## 技术架构

### 多线程设计
```
主线程 (main.py)
├── 初始化线程 (initial.py)
├── 输入/显示线程 (playerInput.py + terminal_GUI.py)
├── 发送线程 (UART_send.py) - 独立线程，50Hz发送
└── 接收线程 (UART_receive.py) - 独立线程，100Hz接收
```

### 数据共享机制
- **ProtocolData类**：线程间共享的数据结构
  - 发送数据：总开关、风扇转速、4个舵机角度
  - 接收数据：开关状态、加速度、陀螺仪、角度数据
- **线程安全**：通过共享对象实现数据同步

### 控制台GUI显示
采用四行动态显示，使用ANSI转义码实现实时刷新：
1. **第一行**：上一次发送的信息（开关、风扇、舵机状态）
2. **第二行**：当前COM口和连接状态
3. **第三行**：当前按键状态（开关、风扇、舵机角度）
4. **第四行**：接收数据（开关、加速度、陀螺仪、角度）

### 性能特性
- **发送频率**：50Hz恒定频率，确保控制指令及时性
- **接收频率**：100Hz检查频率，实时处理传感器数据
- **GUI刷新**：10Hz刷新频率，平衡显示效果和CPU占用
- **错误处理**：完善的异常处理和错误计数机制

## 故障排除

### 常见问题
1. **串口连接失败**
   - 检查USB转TTL模块是否正确连接
   - 确认COM口未被其他程序占用
   - 尝试重新插拔USB设备

2. **按键无响应**
   - 确保程序窗口处于活动状态
   - 检查键盘库权限（Linux/macOS可能需要sudo）
   - 验证按键映射是否正确

3. **数据接收异常**
   - 确认航模设备发送正确的数据格式
   - 检查波特率设置是否匹配（115200）
   - 验证数据包起始和结束字节

### 调试信息
程序启动时会显示可用COM口列表，运行过程中会实时显示发送和接收状态。如遇问题，请检查控制台输出信息。

## 开发注意事项

1. **协议扩展**：如需修改通讯协议，请同步更新`protocol.py`中的编码解码函数
2. **预设状态**：预设状态配置在`playerInput.py`和`initial.py`中，可灵活调整
3. **线程安全**：修改共享数据时需考虑线程同步问题
4. **性能优化**：调整各线程的睡眠时间可平衡性能和资源占用

## 许可证
本项目采用MIT许可证。详细信息请参阅LICENSE文件。

## 贡献指南
欢迎提交Issue和Pull Request来改进本项目。请确保代码符合项目规范并通过基本测试。
